import glob
import os

import pandas as pd


def add_extension_to_all_files(directory, extension):
    """Add extension to all the files in the directory."""
    file_paths = glob.glob(f"{directory}/*", recursive=True)
    for file_path in file_paths:
        # Check if the file has an extension
        if not os.path.splittext(file_path)[-1]:
            os.rename(file_path, file_path + f".{extension}")


def fix_double_extension(directory, extension):
    """Fix files that have the extension twice."""
    file_paths = glob.glob(f"{directory}/*.{extension}.{extension}", recursive=True)
    for file_path in file_paths:
        new_file_path = file_path.rsplit(f".{extension}", 1)[0]
        os.rename(file_path, new_file_path)


if __name__ == "__main__":
    DIRECTORY = "apk"
    EXTENSION = "apk"

    # Add the extension to all the files in the directory
    add_extension_to_all_files(DIRECTORY, EXTENSION)

    # Gather the base names of the APK files
    apk_paths = glob.glob(f"{DIRECTORY}/*.{EXTENSION}", recursive=True)
    apk_names_in_folder = [(os.path.basename(apk_path)) for apk_path in apk_paths]

    # Write the missing APK files to a file
    with open("./apk_list_tags.csv", "r") as read_obf, open(
        "./missing_apks.txt", "w"
    ) as write_obf:
        df = pd.read_csv(read_obf)
        apk_names_in_csv = df["hash"].tolist()

        # Find the missing APK files
        missing_apks = set(apk_names_in_csv) - set(apk_names_in_folder)

        # Write the missing APK files to a file
        for apk in missing_apks:
            write_obf.write(f"{apk}\n")
